name: Persistent RDP with Tailscale (Cron)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

jobs:
  rdp-tailscale:
    runs-on: windows-latest
    timeout-minutes: 1440

    steps:
      # ØªÙØ¹ÙŠÙ„ RDP ÙˆØ­Ø³Ø§Ø¨ Ø¯Ø§Ø¦Ù…
      - name: Enable RDP and Persistent Account
        run: |
          $username = "PersistentRDP"
          $password = "admin@123"

          # ØªÙØ¹ÙŠÙ„ RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $username
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          }

      # ØªØ«Ø¨ÙŠØª Tailscale
      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      # ØªØ´ØºÙŠÙ„ Tailscale ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
      - name: Start Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }

          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }

          Write-Host "============================="
          Write-Host "âœ… RDP & Tailscale Info"
          Write-Host "Address (Tailscale IP): $tsIP"
          Write-Host "Username: PersistentRDP"
          Write-Host "Password: admin@123"
          Write-Host "============================="

      # Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©
      - name: Keep Workflow Alive
        run: |
          Write-Host "ğŸ’» RDP & Tailscale are running. Keeping session alive..."
          while ($true) {
              Start-Sleep -Seconds 300
          }
